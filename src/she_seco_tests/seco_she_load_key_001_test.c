#include <stdio.h>
#include <stdlib.h>
#include "itest.h"
// requirement: Reuse the AES key from ks for encryption and decryption using the same ks imported from NVM

int seco_she_load_key_001(void){

    uint32_t key_storage_identifier = 0xC0A1A;
    uint32_t password = 0xEFFACECA;
    uint16_t max_updates_number = 10;
    uint32_t signed_message_length = 0;
    uint8_t *signed_message = NULL;
    struct she_hdl_s *she_hdl = NULL;
    uint8_t key_ext = 0;
    uint8_t key_id = 4;
    uint8_t key[112] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44,  /*m1 (128 bits)*/
        0xe0, 0xd0, 0x8b, 0xc3, 0x17, 0x36, 0x34, 0x5a,
        0x16, 0x78, 0x57, 0x2d, 0xf7, 0x1f, 0x22, 0xec,
        0x4a, 0xaf, 0x2f, 0xed, 0xcd, 0x28, 0xa6, 0xfc,
        0xb4, 0xe4, 0x11, 0xd3, 0x04, 0xb5, 0x53, 0x1f,  /* m2 (256 bits)*/
        0xf0, 0xe9, 0x29, 0x9c, 0x43, 0xf9, 0xbe, 0xc6,
        0x0a, 0x83, 0x10, 0xad, 0xdf, 0x25, 0xba, 0xba,  /* m3 (128 bits)*/
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
        0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
        0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, /* m4 (256 bits)*/
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f  /* m5 (128 bits)*/
    };
    uint8_t *m1 = key;
    uint8_t *m2 = m1 + 16;
    uint8_t *m3 = m2 + 32;
    uint8_t *m4 = m3 + 16;
    uint8_t *m5 = m4 + 32;

    clear_she_seco_nvm();

    // START NVM
    ASSERT_NOT_EQUAL(start_nvm_she_seco(), NVM_STATUS_STOPPED);

    ASSERT_EQUAL(she_storage_create( key_storage_identifier, password, max_updates_number, signed_message, signed_message_length ), SHE_STORAGE_CREATE_WARNING);

    ASSERT_NOT_EQUAL(she_hdl = she_open_session(key_storage_identifier, password, NULL, NULL), NULL);

    ASSERT_EQUAL(she_cmd_load_key(she_hdl, key_ext, key_id, m1, m2, m3, m4, m5), ERC_NO_ERROR);

    ASSERT_NOT_EQUAL(stop_nvm_she_seco(), NVM_STATUS_STOPPED);

    she_close_session(she_hdl);

    return TRUE_TEST;
}
